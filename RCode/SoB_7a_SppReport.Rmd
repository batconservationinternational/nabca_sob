---
date: "11/9/2021"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_crop: FALSE
graphics: yes
header-includes:
  - \usepackage{booktabs}
  - \usepackage{caption}
params:
  spp: Artibeus jamaicensis
  sppCode: ARJAM
  cntry: MX
  date: 20211109
  rootDir: C:/Box/- Missions & Programs/Research & Development/NABat/NABCA/NABCA SoB Report/SoB_Analysis
  save: FALSE
fontsize: 14pt
---

```{r setup, include=FALSE, echo=F}


library(dplyr)
library(tidyr)
require(ggplot2)
require(ggpubr)


knitr::opts_chunk$set(echo = FALSE,
                      message= FALSE,
                      warning= FALSE)
options(scipen = 999)

knitr::knit_hooks$set(
  inline = function(x) {
    if (!is.numeric(x)) {
      x
    } else{
      prettyNum(round(x, 2), big.mark = ",")
    }
  }
)

title = paste("Assessment of", params$spp, "in", params$cntry)

```

---
title: `r title`
---

```{r dataimport}

saveDir = paste0(params$rootDir, '/SpeciesReports/', params$date, '/')
if (!dir.exists(saveDir)) {
  dir.create(saveDir)
}

DataFolder = paste0(params$rootDir, '/Data/derived/AnalysisExport_', params$date)

DataFiles <- list.files(DataFolder, full.names = T)
DataFile <-
  DataFiles[grepl(
    paste0(
      "SurveyAnswers_",
      params$date,
      "__",
      params$cntry,
      '_',
      params$sppCode,
      "_nestedQ_analyzed.RDS"
    ),
    DataFiles
  )]


#Table of threat lables
Threats <- read.csv(paste0(params$rootDir, '/Data/ThreatNum.csv'))

# Threats <- read.csv(paste0(params$rootDir, '/Data/ThreatNum.csv')) %>% 
#   mutate(Threat = paste0(ThreatN, ": ", Threat))
```

```{r}
sppData <- readRDS(DataFile) %>%
  select(-one_of('perPlots', 'overlap')) %>% suppressWarnings()

```
\captionsetup[table]{labelformat=empty}
# Range Size
```{r out.width = "90%", fig.align='center'}
thisRangeFN <- paste0(params$rootDir, '/RangeGraphs/range_', params$sppCode, "_", params$cntry, '.png')

knitr::include_graphics(thisRangeFN)
```
\newpage
# Population Size

```{r popSize_index}
i_popSz <- which(sppData$Q_group=='pop' & sppData$Q_sub=='Size')
```

## Expert Elicited Values
```{r popSize_data, results='asis'}
sppData[i_popSz, 'data'][[1]][[1]] %>% 
  select(min, mean, max, conf, token) %>% 
  # left_join(as_tibble(sppData[i_popSz, 'experts'][[1]][[1]]$labels, rownames=c('token'))) %>% 
  mutate(conf=paste0(conf*100, "%")) %>% 
  rename(central=mean,
         confidence=conf, 
         expert=token) %>% 
  select(expert, everything()) %>% 
  mutate(across(where(is.numeric), ~prettyNum(.x,big.mark = ','))) %>% 
  knitr::kable()
  # stargazer::stargazer()
```

## Distribution
```{r popSize_graph}
sppData[i_popSz, 'D_plot'][[1]][[1]]+
  scale_color_manual(values=
                       ggplot_build(sppData[i_popSz, 'D_plot'][[1]][[1]])
                                  [["plot"]][["scales"]][["scales"]][[2]][["palette.cache"]])+
  theme(legend.position = 'bottom', legend.title = element_blank())+
  guides(color=guide_legend(ncol=4))
  

```

```{r popSize_quantiles, results='asis'}
sppData[i_popSz, 'Quantiles'][[1]][[1]] %>% 
  select(-P99) %>% 
  # left_join(as_tibble(sppData[i_popSz, 'experts'][[1]][[1]]$labels, rownames=c('expert'))) %>% 
  # mutate(expert=value) %>% 
  select(expert, Q1, Median, Q3) %>% 
  mutate(across(where(is.numeric), ~prettyNum(.x,big.mark = ','))) %>% 
  knitr::kable()
  # stargazer::stargazer()
```
\newpage

# Population Trend

```{r popTrend_index}
i_popT <- which(sppData$Q_group=='pop' & sppData$Q_sub=='Trend')
```

## Expert Elicited Values
```{r popTrend_data}
sppData[i_popT, 'data'][[1]][[1]] %>% 
  select(min, mean, max, conf, token) %>% 
  # left_join(as_tibble(sppData[i_popSz, 'experts'][[1]][[1]]$labels, rownames=c('token'))) %>% 
  mutate(conf=paste0(conf*100, "%"),
         min=paste0(min*100, "%"),
         max=paste0(max*100, "%"),
         mean=paste0(mean*100, "%")
        ) %>% 
  rename(central=mean,
         confidence=conf, 
         expert=token) %>% 
  select(expert, everything()) %>% 
  mutate(across(where(is.numeric), ~prettyNum(.x,big.mark = ',')))%>% 
  knitr::kable()
  # stargazer::stargazer()
```

## Distribution
```{r popTrend_graph}
# sppData[i_popT, 'D_plot'][[1]][[1]] -> gg

 g <- ggplot_build(sppData[i_popT, 'D_plot'][[1]][[1]])

sppData[i_popT, 'D_plot'][[1]][[1]]+
  scale_color_manual(values=
                       ggplot_build(sppData[i_popT, 'D_plot'][[1]][[1]])
                                  [["plot"]][["scales"]][["scales"]][[2]][["palette.cache"]])+
  theme(legend.position = 'bottom', legend.title = element_blank())+
  guides(color=guide_legend(ncol=4))

```

```{r popTrend_quantiles}
sppData[i_popT, 'Quantiles'][[1]][[1]] %>% 
  select(-P99) %>% 
  # left_join(as_tibble(sppData[i_popSz, 'experts'][[1]][[1]]$labels, rownames=c('expert'))) %>% 
  # mutate(expert=value) %>% 
  select(expert, Q1, Median, Q3) %>% 
  mutate(across(where(is.numeric), ~prettyNum(.x,big.mark = ','))) %>% 
  mutate(Median=paste0(round(as.numeric(Median)*100, digits = 0), "%"),
       Q1=paste0(round(as.numeric(Q1)*100, digits = 0), "%"),
       Q3=paste0(round(as.numeric(Q3)*100, digits = 0), "%")
  )%>% 
  knitr::kable()
  # stargazer::stargazer()
```

\newpage

# Threat Assessment

Scope, Severity, and resulting population impact for IUCN level 2 threats.

If a plot is missing, data was missing from the original survey (e.g., one or more of the questions was left blank ("-").

The expert rated the threat as 'neglibile' if min =0, central=0.5, max=1, and conf=99.99%"

```{r functions}

show_DataTable <- function(t, e){
  t%>% 
  select(min, mean, max, conf, token) %>% 
  # left_join(as_tibble(e, rownames=c('token'))) %>% 
  mutate(conf=paste0(conf*100, "%")) %>% 
  rename(central=mean,
         confidence=conf, 
         expert=token) %>% 
  select(expert, everything()) %>%
  mutate(across(where(is.numeric), ~round(.x,3)*100))

}

show_QuantileTable <- function(t, e){
  t %>% 
  select(-P99) %>% 
  # left_join(as_tibble(e, rownames=c('expert'))) %>% 
  # mutate(expert=value) %>% 
  select(expert, Q1, Median, Q3) %>% 
  mutate(across(where(is.numeric), ~prettyNum(.x,big.mark = ','))) %>% 
  mutate(Median=paste0(round(as.numeric(Median)*100, digits = 0), "%"),
       Q1=paste0(round(as.numeric(Q1)*100, digits = 0), "%"),
       Q3=paste0(round(as.numeric(Q3)*100, digits = 0), "%")
  )
}
```



```{r ThreatsStuff}

TData <- sppData %>% 
  filter( stringr::str_detect(Q_sub, 'sub'))

allThreats_stuff <- TData %>% 
  select(Threat, subT) %>% 
  distinct() %>% 
  plyr::dlply(., 'Threat', .fun=function(df){
   plyr::dlply(df, 'subT', .fun=function(df){
     list()
     }) 
  })

TData <- split(TData, TData$LimeGroup)


file.exists(paste0(params$rootDir, '/Data/derived/AnalysisExport_', params$date, '/',
    'SurveyAnswers_',
    params$date,
    '__',
    params$cntry,
    '_',
    params$sppCode,
    '_nestedQ_analyzed_T2.RDS'
  ))


ThreatAnalysis <- readRDS(list.files(
  paste0(params$rootDir, '/Data/derived/AnalysisExport_', params$date),
  pattern = paste0(
    'SurveyAnswers_',
    params$date,
    '__',
    params$cntry,
    '_',
    params$sppCode,
    '_nestedQ_analyzed_T2.RDS'
  ),
  full.names = T
))

ThreatAnalysis <- split(ThreatAnalysis, ThreatAnalysis$LimeGroup)


for (gN in names(TData)) {
  
  gT1 <- unique(Threats[Threats$LimeGroup == gN, 'Threat'])
  
  thisT1 <- TData[[gN]]
  
  thisT2 <- ThreatAnalysis[[gN]]
  
  for (sT in unique(Threats[Threats$LimeGroup == gN, 'subT'])) {

    ThisThreat <- thisT1 %>%
      filter(subT == sT)
    
    ThisTImpact <- ThreatAnalysis[[gN]] %>%
      filter(subT == sT) %>%
      select(Impact)
    
    
    #Table of raw data for scope
    D_scope <- tryCatch(
      show_DataTable(t=ThisThreat[ThisThreat$Q_ss == 'Scope', 'data'][[1]][[1]], 
                     e=ThisThreat[1, 'experts'][[1]][[1]]$labels),
      error = function(e) data.frame('Expert'= NA, 'min' = NA, 'central' = NA, 'max' = NA, 'confidence' = NA)
    )
    
    #Table of raw data for severity
    D_severity <- tryCatch(
      show_DataTable(ThisThreat[ThisThreat$Q_ss == 'Severity', 'data'][[1]][[1]], ThisThreat[1, 'experts'][[1]][[1]]$labels),
      error = function(e) data.frame('Expert'= NA, 'min' = NA, 'central' = NA, 'max' = NA, 'confidence' = NA)
      )
    
    #plot of distributions
    thisPlotT2 <- tryCatch({
      gScope <-
        ThisThreat[ThisThreat$Q_ss == 'Scope', 'D_plot'][[1]][[1]] + labs(title = 'Scope')
      
      gSeverity <-
        ThisThreat[ThisThreat$Q_ss == 'Severity', 'D_plot'][[1]][[1]] + labs(title = 'Severity')
      
      gScope <- gScope +
        scale_color_manual(values =
                             ggplot_build(gScope)[["plot"]][["scales"]][["scales"]][[2]][["palette.cache"]]) +
        guides(color=guide_legend(ncol=4))+
        theme(legend.position = 'bottom', legend.title = element_blank())
      
      gSeverity <- gSeverity +
        scale_color_manual(values =
                             ggplot_build(gSeverity)[["plot"]][["scales"]][["scales"]][[2]][["palette.cache"]]) +
        guides(color=guide_legend(ncol=4))+
        theme(legend.position = 'bottom', legend.title = element_blank())
      
      ggarrange(gScope,
                gSeverity,
                common.legend = T)
    },
    error = function(e)
      NA)
    
    
    #table of quantiles of scope
    Q_scope <- tryCatch(
      show_QuantileTable(t=ThisThreat[ThisThreat$Q_ss == 'Scope', 'Quantiles'][[1]][[1]], 
                         e=ThisThreat[1, 'experts'][[1]][[1]]$labels),
      error = function(e) data.frame('Expert'= NA, 'Q1' = NA, 'Median' = NA, 'Q3' = NA)
    )
    
    #table of quantiles of severity
    Q_severity <- tryCatch(
      show_QuantileTable(ThisThreat[ThisThreat$Q_ss == 'Severity', 'Quantiles'][[1]][[1]], 
                         ThisThreat[1, 'experts'][[1]][[1]]$labels),
      error = function(e) data.frame('Expert'= NA, 'Q1' = NA, 'Median' = NA, 'Q3' = NA)
    )
    
    
    #plot of Impact
    tryCatch( {
      p_Impact <- ThisTImpact$Impact[[1]]$ImpactPlot+
        scale_color_manual(values =
                             ggplot_build(ThisTImpact$Impact[[1]]$ImpactPlot)[["plot"]][["scales"]][["scales"]][[2]][["palette.cache"]]) +
        guides(color=guide_legend(ncol=4))+
        theme(legend.position = 'bottom', legend.title = element_blank())
      
      },
      error = function(e) NA
    )
    
    
    #table of quantiles of impact
   Q_Impact <- tryCatch({
      Q_Impact1 <- t(bind_rows(ThisTImpact$Impact[[1]]$Quantiles))
      colnames(Q_Impact1) <- c('Q1', 'Median', 'Q3')
      
       Q_Impact1 %>% as_tibble(rownames = 'Expert') %>%
          mutate(
            Median = paste0(round(as.numeric(Median) * 100, digits = 0), "%"),
            Q1 = paste0(round(as.numeric(Q1) * 100, digits = 0), "%"),
            Q3 = paste0(round(as.numeric(Q3) * 100, digits = 0), "%")
          ) %>% return()
      
    }
      , error = function(e) data.frame('Expert'= NA, 'Q1' = NA, 'Median' = NA, 'Q3' = NA)
      )
  
    allThreats_stuff[[gT1]][[sT]]=list(rawScope=D_scope,
                                       rawSeverity=D_severity,
                                       DistPlot=thisPlotT2,
                                       quantileScope=Q_scope,
                                       quantileSeverity=Q_severity,
                                       ImpactPlot=p_Impact,
                                       quantileImpact=Q_Impact)
  }
  

}


if(params$save==T) {
  ThisDir <-
    paste0(params$rootDir, "/Data/RelevantData_", params$date)
  
  if (!dir.exists(ThisDir))
    dir.create(ThisDir)
  
  
  saveRDS(
    allThreats_stuff,
    file = paste0(
      ThisDir,
      "/",
      params$sppCode,
      "_",
      params$cntry,
      "_",
      params$date,
      '.RDS'
    )
  )
}
```


```{r displayResults, results='asis'}
# names(allThreats_stuff) %>% 

# threatsOrdered <- unique(Threats$Threat)

for(T1 in unique(Threats$Threat)) {
  
  
  #T1 Heading
  cat('  \n## ', T1, '  \n')
  
  for (T2 in names(allThreats_stuff[[T1]])) {
    #T2 Heading
    cat('  \n### ', T2, '  \n')
    
    
    cat('  \n#### ', 'Expert Elicited Values', '  \n')

        # cat("\\",
        #   c(
        #      "\\begin{table}[!htb]
        #         \\begin{minipage}{.5\\linewidth}
        #             \\caption{Scope}
        #             \\centering",
        #             knitr::kable(allThreats_stuff[[T1]][[T2]]$rawScope, format='latex', booktabs=T),
        #        "\\end{minipage}%
        #         \\begin{minipage}{.5\\linewidth}
        #           \\centering
        #           \\caption{Severity}",
        #           knitr::kable(allThreats_stuff[[T1]][[T2]]$rawSeverity, format='latex', booktabs=T) ,
        #        "\\end{minipage}
        #      \\end{table}"
        #   )
        # )
    
    cat("\n\n")
    
            cat("\\",
          c(
             "\\begin{table}[!htb]
                    \\caption{Scope}
                    \\centering",
                    knitr::kable(allThreats_stuff[[T1]][[T2]]$rawScope, format='latex', booktabs=T),
             "\\end{table}"
          )
        )
            
                cat("\\",
          c(
             "\\begin{table}[!htb]
                  \\centering
                  \\caption{Severity}",
                  knitr::kable(allThreats_stuff[[T1]][[T2]]$rawSeverity, format='latex', booktabs=T) ,
             "\\end{table}"
          )
        )

        print(allThreats_stuff[[T1]][[T2]]$DistPlot)

        cat("  \n\n") 
        
        # cat("\\",
        #   c(
        #      "\\begin{table}[!htb]
        #         \\begin{minipage}{.5\\linewidth}
        #             \\caption{Scope}
        #             \\centering",
        #             knitr::kable(allThreats_stuff[[T1]][[T2]]$quantileScope, format='latex', booktabs=T),
        #        "\\end{minipage}%
        #         \\begin{minipage}{.5\\linewidth}
        #           \\centering
        #           \\caption{Severity}",
        #           knitr::kable(allThreats_stuff[[T1]][[T2]]$quantileSeverity, format='latex', booktabs=T) ,
        #        "\\end{minipage}
        #      \\end{table}"
        #   )
        # )
        cat("\n\n")
        
                    cat("\\",
          c(
             "\\begin{table}[!htb]
                    \\caption{Scope}
                    \\centering",
                    knitr::kable(allThreats_stuff[[T1]][[T2]]$quantileScope, format='latex', booktabs=T),
             "\\end{table}"
          )
        )
            cat("\n\n")
            
            cat("\n\n")
            
                cat("\\",
          c(
             "\\begin{table}[!htb]
                  \\centering
                  \\caption{Severity}",
                  knitr::kable(allThreats_stuff[[T1]][[T2]]$quantileSeverity, format='latex', booktabs=T) ,
             "\\end{table}"
          )
        )
        
        cat("\n\n")
        cat("\n\n\\pagebreak\n")
        # cat("  \n")#end Elicit heading
        
    cat('#### ', 'Impact', '  \n')
     cat("\n\n")

        cat("\\",
          c("\\begin{table}[!htb]
                    \\caption{Impact}
                    \\centering",
                    knitr::kable(allThreats_stuff[[T1]][[T2]]$quantileImpact, format='latex', booktabs=T),
            "\\end{table}"
            )
          )
        
        cat("  \n")
        cat("\n\n")
        print(allThreats_stuff[[T1]][[T2]]$ImpactPlot)
        cat("  \n\n")
        cat("\n\n\\pagebreak\n")
        

  } #end T2
  cat("  \n") #End T1 heading
  cat("\n\n\\pagebreak\n")
} #end T1
```
